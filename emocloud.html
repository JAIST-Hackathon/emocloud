<!DOCTYPE html>
<html>
  <head>
    <title>マップ</title>
    <meta charset="utf-8" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px;
        border-radius: 8px;
        z-index: 2;
      }
      #toggleMapControl {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 6px 10px;
        border-radius: 8px;
        z-index: 2;
      }
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      表示範囲:
      <select id="range">
        <option value="20">20m</option>
        <option value="50">50m</option>
        <option value="100" selected>100m</option>
      </select>
    </div>
    <button id="toggleMapControl">操作モードを有効にする</button>
    <div id="map"></div>

    <script>
      let map;
      let currentLocation = null;
      let mapLocked = true;

      const zoomLevels = {
        20: 20,
        50: 19,
        100: 18,
      };

      function initMap() {
        const styledMapType = new google.maps.StyledMapType(
          [
            { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
            { elementType: "labels", stylers: [{ visibility: "off" }] },
            { featureType: "administrative", stylers: [{ visibility: "off" }] },
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#cccccc" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#e0e0e0" }] }
          ],
          { name: "Gray No Labels" }
        );

        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 35.681236, lng: 139.767125 },
          zoom: 18,
          disableDefaultUI: true,
          draggable: false,
          gestureHandling: "none",
          keyboardShortcuts: false,
        });

        map.mapTypes.set("styled_map", styledMapType);
        map.setMapTypeId("styled_map");

        // 操作切り替えボタンの処理
        document.getElementById("toggleMapControl").addEventListener("click", function () {
          mapLocked = !mapLocked;

          map.setOptions({
            draggable: !mapLocked,
            gestureHandling: mapLocked ? "none" : "greedy",
            zoomControl: !mapLocked,
        });

        this.textContent = mapLocked
            ? "操作モードを有効にする"
            : "操作モードを終了する";

        // 操作モード終了時に中心を現在地に戻す
        if (mapLocked && currentLocation) {
            map.setCenter(currentLocation);
        }
    });

        // 現在地取得とマーカー表示
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };

            const selectedDistance = document.getElementById("range").value;
            map.setCenter(currentLocation);
            map.setZoom(zoomLevels[selectedDistance]);

            new google.maps.Marker({
                position: currentLocation,
                map: map,
                title: "あなたの現在地",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "#007AFF",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "#ffffff",
                },
            });
            },
            () => alert("現在地を取得できませんでした。")
        );
        } else {
            alert("このブラウザは位置情報に対応していません。");
        }

        // 範囲変更イベント
        document.getElementById("range").addEventListener("change", function () {
            const zoom = zoomLevels[this.value];
            if (map && currentLocation) {
                map.setZoom(zoom);
            }
        });
    }

    // POST処理関数
    async function postDataToEmocloud(color, latitude, longitude, timestamp) {
      const url = 'https://tyho3rn3ca.execute-api.ap-southeast-2.amazonaws.com/emocloudData';

      const payload = {
        color,
        latitude,
        longitude,
        timestamp
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const text = await response.text();
        const parsed = JSON.parse(text);
        console.log('送信成功:', parsed);
        return parsed;

      } catch (error) {
        console.error('送信エラー:', error.message);
        return null;
      }
    }


    </script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0gZqkL68rgvnjUU7fNmVfRyydR-lDBaA&callback=initMap"
        async defer
    ></script>
    </body>
</html>
